<div *ngIf="usager">
  <div class="container">
    <div class="row">
      <div class="col-md-2 text-left">
        <a routerLink="/manage/">
          <fa-icon icon="angle-left"></fa-icon>
          Retour à la liste
        </a>
      </div>
      <div class="col-md-8 text-center">
        <div
          id="profil_head"
          [ngClass]="{
              'text-danger': usager.dayBeforeEnd < 15,
              'text-warning': usager.dayBeforeEnd > 15 && usager.dayBeforeEnd < 60
            }">
          <h2 id="profil_name">{{ usager.nomComplet }}</h2>
          Numéro domicilié :
          <b>{{ usager.id }}</b>
        </div>
        <div
          class=" text-center"
          *ngIf="usager.decision.statut === 'REFUS'">
          <h4 class="text-danger">
            Demande refusée le {{ usager.decision.dateDecision | date: "dd/MM/yyyy à HH:MM" }}
          </h4>
          <p class="font-weight-bold text-danger">
            Motif :
            <span *ngIf="usager.decision.motif !== 'AUTRE'">
              {{ motifsRefus[usager.decision.motif] }}
            </span>
            <span *ngIf="usager.decision.motif === 'AUTRE'">{{ usager.decision.motifDetails }}</span>
            <br>
            <b>Orientation proposée :</b>
            {{ usager.decision.orientationDetails}}
          </p>
          <button
            (click)="getAttestation()"
            class="btn btn-primary">
            <fa-icon icon="download"></fa-icon>
            Télécharger le CERFA de refus
          </button>

        </div>

        <div
          class="text-center font-weight-bold text-danger"
          *ngIf="usager.decision.statut === 'RADIE'">

          <h4 class="text-danger">
            Radié{{ usager.sexe === "homme" ? "" : "e" }} le {{ usager.decision.dateDecision | date: 'dd/MM/yyyy à HH:MM' }}
            <br>
            <span *ngIf="usager.decision.motif !== 'AUTRE'">
              {{ motifsRadiation[usager.decision.motif] }}
            </span>
            <span *ngIf="usager.decision.motif === 'AUTRE'">{{ usager.decision.motifDetails }}</span>
          </h4>
          <a
            [routerLink]="['/radiation/'+usager.id]"
            class="btn btn-primary">
            <fa-icon icon="print"></fa-icon>
            &ensp;
            Imprimer le courrier de radiation
          </a>
        </div>
        <div
          class="text-center"
          *ngIf="usager.decision.statut === 'VALIDE'">
          <span
            [ngClass]="{
              'text-danger': usager.dayBeforeEnd <= 15,
              'text-warning': usager.dayBeforeEnd > 15 && usager.dayBeforeEnd < 60
            }"
            *ngIf="usager.dayBeforeEnd > 0">
            Domiciliation valable jusqu'au
            <b [ngClass]="{
              'text-warning': usager.dayBeforeEnd > 15 && usager.dayBeforeEnd < 60,
              'text-secondary': usager.dayBeforeEnd >= 60
             }">
              {{ usager.decision.dateFin | date: 'dd/MM/yyyy'  }}
            </b>
          </span>
          <span
            class="text-danger"
            *ngIf="usager.dayBeforeEnd < 0">
            <fa-icon icon="exclamation-triangle"></fa-icon>
            Domiciliation expirée depuis le
            <b>
              {{ usager.decision.dateFin | date: 'dd/MM/yyyy'  }}
            </b>
            (il y a {{ usager.dayBeforeEnd*-1 }} jours)
          </span>
          <br>
          <span *ngIf="usager.lastInteraction.dateInteraction !== null">
            Dernier passage le
            <b>
              {{ usager.lastInteraction.dateInteraction | date: 'dd/MM/yyyy' }}
            </b>
          </span>
        </div>
        <div
          *ngIf="usager.decision.statut === 'VALIDE' && usager.dayBeforeEnd < 60"
          class="text-center row">
          <div class="w-100">
            <br>
          </div>
          <div class="col-md-5 offset-1">
            <button
              (click)="open(renewConfirmation)"
              *ngIf="usager.dayBeforeEnd < 60"
              class="btn btn-block btn-secondary">
              <fa-icon icon="redo"></fa-icon>
              Demande de renouvellement
            </button>
          </div>
          <div class="col-md-5">
            <a
              *ngIf="usager.dayBeforeEnd < 0"
              [routerLink]="['/radiation/'+usager.id]"
              routerLinkActive="router-link-active"
              class="btn btn-block btn-danger">
              <fa-icon icon="times"></fa-icon>
              Radier le domicilié
            </a>
          </div>
          <div class="w-100">
            <br>
          </div>
        </div>
      </div>
      <br>
      <ngb-alert
        type="warning"
        *ngIf="usager.decision.statut === 'ATTENTE_DECISION'">
        Demande en cours, à valider par un responsable
      </ngb-alert>
    </div>

    <div *ngIf="usager.decision.statut === 'VALIDE'">
      <br>
      <h5 class="text-center font-weight-bold">
        Signaler la réception d’un courrier ou un passage
      </h5>
      <br>
      <div id="notif-container">
        <div id="notif-form">
          <div>
            <fa-icon icon="envelope"></fa-icon>
            <input
              min="0"
              max="100"
              [(ngModel)]="notifInputs.courrierIn"
              class="form-control"
              type="number">
            <span>Courriers reçus</span>
          </div>
          <div>
            <fa-icon icon="envelope"></fa-icon>
            <input
              min="0"
              max="100"
              [(ngModel)]="notifInputs.recommandeIn"
              class="form-control"
              type="number">
            <span>
              <b>Avis de passage</b>
              reçus
            </span>
          </div>
          <div>
            <fa-icon icon="box"></fa-icon>
            <input
              min="0"
              max="100"
              [(ngModel)]="notifInputs.colisIn"
              class="form-control"
              type="number">
            <span>Colis reçus</span>
          </div>
        </div>

        <div
          id="notif_button"
          class="text-center">
          <button
            (click)="notifier()"
            class="btn btn-primary btn-block">
            Enregistrer
          </button>
        </div>

        <div id="big_icons">
          <div
            class="text-center"
            (click)="setPassage('visite')">
            <fa-icon
              icon="walking"
              size="3x"
              class="visite actions_icones">
            </fa-icon>
            <span>Passage sans récupérer de courrier</span>
          </div>
          <div
            class="text-center"
            [ngClass]="appelAuj"
            (click)="setPassage('appel')">
            <fa-icon
              class="actions_icones appel"
              icon="phone"
              size="3x">
            </fa-icon>
            <span>A appelé</span>
          </div>
        </div>
      </div>
    </div>
    <br>
    <ngb-alert
      [dismissible]='false'
      *ngIf="usager.lastInteraction.nbCourrier > 0"
      type="dark">
      <div class="text-center">
        <fa-icon
          id="courrier"
          icon="envelope-open-text"></fa-icon>
        &nbsp;&nbsp;{{ usager.lastInteraction.nbCourrier }} courriers en attente&nbsp;&nbsp;&nbsp;
        <button
          class="btn btn-primary"
          (click)="setPassage('courrierOut')">
          Confirmer la distribution
        </button>
      </div>
    </ngb-alert>
    <ngb-accordion
      #acc="ngbAccordion"
      activeIds="panel-0,panel-1,panel-5">
      <ngb-panel
        id="panel-0"
        *ngIf="usager.decision.statut !== 'REFUS'">
        <ng-template
          ngbPanelHeader
          let-opened="opened">
          <div class="head-panel">
            <button
              ngbPanelToggle
              class="btn btn-link">
              <span>SUIVI DU COURRIER ET DES PASSAGES</span>
              <span class="arrows">
                <fa-icon
                  *ngIf="opened"
                  icon="chevron-down"></fa-icon>
                <fa-icon
                  *ngIf="!opened"
                  icon="chevron-right"></fa-icon>
              </span>
            </button>
          </div>
        </ng-template>
        <ng-template ngbPanelContent>
          <ngb-alert
            *ngIf="interactions.length == 0"
            [dismissible]="false">
            Aucune interaction enregistrée
          </ngb-alert>
          <table
            id="interactions-table"
            class="table table-light table-hover"
            *ngIf="interactions.length >0">
            <thead>
              <tr>
                <th>Type d'interaction</th>
                <th>Date</th>
                <th>Notifié par</th>
                <th></th>
              </tr>
            </thead>
            <tbody *ngFor="let interaction of interactions | slice:0:10; let i=index;">
              <tr *ngIf="interaction.delete === true">
                <td
                  colspan="4"
                  class="delete-interaction">
                  Êtes-vous sur de vouloir supprimer cette interaction ?
                  <button
                    class="btn btn-danger"
                    (click)="deleteInteraction(interaction.id)">
                    Oui
                  </button>
                  <button
                    class="btn btn-dark"
                    (click)="interaction.delete = false">
                    Non
                  </button>
                </td>
              </tr>
              <tr *ngIf="!interaction.delete">
                <td>
                  <b *ngIf="!interaction.edit">{{ this.interaction.label }}</b>
                  <div *ngIf="interaction.edit">
                    <select>
                      <option value>CHIPS</option>
                      <option value>COCA</option>
                      <option value></option>
                    </select>
                  </div>
                </td>
                <td>
                  {{ interaction.dateInteraction | date: 'dd/MM/yyyy à HH:mm' }}
                </td>
                <td>{{ interaction.userName }}</td>
                <td
                  class="interactions-actions edit-interaction"
                  *ngIf="interaction.edit === true">
                  <fa-icon
                    icon="times"
                    (click)="interaction.edit = false"
                    class="btn btn-dark"></fa-icon>
                  <fa-icon
                    icon="check"
                    (click)="interaction.edit = false"
                    class="success btn btn-success"></fa-icon>
                </td>
                <td
                  class="interactions-actions"
                  *ngIf="!interaction.delete && !interaction.edit">
                  <span (click)="interaction.edit = false; interaction.delete = true">
                    <fa-icon
                      icon="trash-alt"
                      class="delete"></fa-icon>
                  </span>
                  <span
                    *ngIf="false"
                    (click)="interaction.edit = true;interaction.delete = false">
                    <fa-icon
                      icon="pencil-alt"
                      class="edit"></fa-icon>
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </ng-template>
      </ngb-panel>
      <ngb-panel id="panel-1">
        <ng-template
          ngbPanelHeader
          let-opened="opened">
          <div class="head-panel">
            <button
              ngbPanelToggle
              class="btn btn-link">
              <span>HISTORIQUE DE LA DOMICILIATION</span>
              <span class="arrows">
                <fa-icon
                  *ngIf="opened"
                  icon="chevron-down"></fa-icon>
                <fa-icon
                  *ngIf="!opened"
                  icon="chevron-right"></fa-icon>
              </span>
            </button>
          </div>
        </ng-template>
        <ng-template ngbPanelContent>
          <table
            *ngIf="usager.historique.length > 0"
            class="table table-light table-hover">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type de décision</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  {{ usager.decision.dateDecision | date: 'dd/MM/yyyy'}}
                </td>
                <td>
                  {{ decisionLabels[usager.decision.statut] }}
                  <b *ngIf="usager.decision.statut === 'VALIDE'">
                    du {{ usager.decision.dateDebut | date: 'dd/MM/yyyy' }}
                    au {{ usager.decision.dateFin | date: 'dd/MM/yyyy'}}
                  </b>
                  <b *ngIf="usager.decision.statut === 'RADIE'">
                    -
                    <span *ngIf="usager.decision.motif !== 'AUTRE'">
                      {{ motifsRadiation[usager.decision.motif] }}
                    </span>
                    <span *ngIf="usager.decision.motif === 'AUTRE'">{{ usager.decision.motifDetails }}</span>
                  </b>
                </td>

                <td>{{ usager.decision.userName }}</td>
              </tr>
              <tr *ngFor="let histo of usager.historique">
                <td>
                  {{ histo.dateDecision | date: 'dd/MM/yyyy'}}
                </td>
                <td>
                  {{ decisionLabels[histo.statut] }}
                  <span *ngIf="histo.statut === 'VALIDE'">
                    du
                    <b>
                      {{ usager.decision.dateDebut | date: 'dd/MM/yyyy' }}
                    </b>
                    au
                    <b>
                      {{ usager.decision.dateFin | date: 'dd/MM/yyyy'}}
                    </b>
                  </span>
                  <div *ngIf="histo.statut === 'RADIE'">
                    -
                    <span *ngIf="histo.motif !== 'AUTRE'">{{ motifsRadiation[histo.motif] }}</span>
                    <span *ngIf="histo.motif === 'AUTRE'">{{ histo.motifDetails }}</span>
                  </div>
                </td>

                <td>{{ histo.userName }}</td>
              </tr>
            </tbody>
          </table>

        </ng-template>
      </ngb-panel>

      <ngb-panel id="panel-2">
        <ng-template
          ngbPanelHeader
          let-opened="opened">
          <div class="head-panel">
            <button
              ngbPanelToggle
              class="btn btn-link">
              <span>ÉTAT CIVIL</span>
              <span class="arrows">
                <fa-icon
                  *ngIf="opened"
                  icon="chevron-down"></fa-icon>
                <fa-icon
                  *ngIf="!opened"
                  icon="chevron-right"></fa-icon>
              </span>
            </button>
          </div>
        </ng-template>

        <ng-template ngbPanelContent>
          <div class="row">

            <div class="col-md-4 reponses">
              <span class="question">NOM</span>
              <span class="valeur">{{ usager.nom }}</span>
            </div>

            <div class="col-md-4 reponses">
              <span class="question">PRÉNOM</span>
              <span class="valeur">{{ usager.prenom }}</span>
            </div>
            <div class="col-md-4 reponses">
              <span class="question">SURNOM</span>
              <span class="valeur">{{ usager.surnom }}</span>
            </div>
            <div class="col-md-4 reponses">
              <span class="question">SEXE</span>
              <span class="valeur">{{ usager.sexe }}</span>
            </div>

            <div class="col-md-4 reponses">
              <span class="question">Date de naissance</span>
              <span class="valeur">
                {{ usager.dateNaissance | date: "dd/MM/yyyy" }}
              </span>
            </div>

            <div class="col-md-4 reponses">
              <span class="question">VILLE de naissance</span>
              <span class="valeur">{{ usager.villeNaissance }}</span>
            </div>

            <div class="col-md-4 reponses">
              <span class="question">Numéro de téléphone</span>
              <span class="valeur">{{ usager.phone }}</span>
            </div>
            <div class="col-md-4 reponses">
              <span class="question">Adresse email</span>
              <span class="valeur">{{ usager.email }}</span>
            </div>

            <div class="col-md-4 reponses"></div>

          </div>

        </ng-template>
      </ngb-panel>

      <ngb-panel id="panel-3">
        <ng-template
          ngbPanelHeader
          let-opened="opened">
          <div class="head-panel">
            <button
              ngbPanelToggle
              class="btn btn-link">
              <span>AYANTS-DROITS</span>
              <span class="arrows">
                <fa-icon
                  *ngIf="opened"
                  icon="chevron-down"></fa-icon>
                <fa-icon
                  *ngIf="!opened"
                  icon="chevron-right"></fa-icon>
              </span>
            </button>
          </div>
        </ng-template>

        <ng-template ngbPanelContent>
          <div *ngIf="usager.ayantsDroits.length === 0">
            <ngb-alert [dismissible]="false">Aucun ayant-droit enregistré</ngb-alert>
          </div>
          <table
            *ngIf="usager.ayantsDroits.length > 0"
            class="table table-light">
            <tbody>
              <tr>
                <th>Nom</th>
                <th>Prénom</th>
                <th>Né le</th>
                <th>Lien</th>
              </tr>
              <tr *ngFor="let ayantDroit of usager.ayantsDroits">
                <td>{{ ayantDroit.nom }}</td>
                <td>{{ ayantDroit.prenom }}</td>
                <td>{{ ayantDroit.dateNaissance }}</td>
                <td>{{ ayantDroit.lien }}</td>
              </tr>
            </tbody>
          </table>
        </ng-template>
      </ngb-panel>

      <ngb-panel id="panel-4">
        <ng-template
          ngbPanelHeader
          let-opened="opened">
          <div class="head-panel">
            <button
              ngbPanelToggle
              class="btn btn-link">
              <span>ENTRETIEN</span>
              <span class="arrows">
                <fa-icon
                  *ngIf="opened"
                  icon="chevron-down"></fa-icon>
                <fa-icon
                  *ngIf="!opened"
                  icon="chevron-right"></fa-icon>
              </span>
            </button>
          </div>
        </ng-template>

        <ng-template ngbPanelContent>
          <div class="row">

            <div class="col-md-4 reponses">
              <span class="question">DOMICILIATION EXISTANTE</span>
              <span class="valeur">
                {{ usager.entretien.domiciliation ? "Oui" : "Non" }}
              </span>
            </div>

            <div class="col-md-4 reponses">
              <span class="question">REVENUS</span>
              <span class="valeur">
                {{ usager.entretien.revenus ? "Oui: " + usager.entretien.revenusDetail : "Non" }}
              </span>
            </div>

            <div class="col-md-4 reponses">
              <span class="question">LIEN COMMUNE</span>
              <span class="valeur">
                {{ usager.entretien.liencommune || "Non renseigné" }}
              </span>
            </div>

            <div class="col-md-4 reponses">
              <span class="question">MOTIF DE LA DEMANDE</span>
              <span
                class="valeur"
                *ngIf="usager.entretien.raison == 'AUTRE'">
                Autre : {{ usager.entretien.raisonDetail }}
              </span>
              <span
                class="valeur"
                *ngIf="usager.entretien.raison != 'AUTRE'">
                {{ labels.raison[usager.entretien.raison] || "Non renseigné" }}
              </span>
            </div>

            <div class="col-md-4 reponses">
              <span class="question">SITUATION RESIDENTIELLE</span>
              <span
                class="valeur"
                *ngIf="usager.entretien.residence == 'AUTRE'">
                Autre : {{ usager.entretien.residenceDetail }}
              </span>
              <span
                class="valeur"
                *ngIf="usager.entretien.residence != 'AUTRE'">
                {{ labels.residence[usager.entretien.residence] || "Non renseigné" }}
              </span>
            </div>
            <div class="col-md-4 reponses">
              <span class="question">COMPOSITION MÉNAGE</span>
              <span class="valeur">
                {{ labels.typeMenage[usager.entretien.typeMenage] || "Non renseigné" }}
              </span>
            </div>

            <div class="col-md-4 reponses">
              <span class="question">CAUSE DE L'INSTABILITÉ LOGEMENT</span>
              <span
                class="valeur"
                *ngIf="usager.entretien.cause == 'AUTRE'">
                Autre : {{ usager.entretien.causeDetail }}
              </span>
              <span
                class="valeur"
                *ngIf="usager.entretien.cause != 'AUTRE'">
                {{ labels.cause[usager.entretien.cause] || "Non renseigné" }}
              </span>
            </div>

            <div class="col-md-4 reponses">
              <span class="question">ACCOMPAGNEMENT SOCIAL ACTUEL</span>
              <span class="valeur">
                {{ usager.entretien.accompagnement ? "Oui : " : "Non" }}
                <span *ngIf="usager.entretien.accompagnement">
                  {{ usager.entretien.accompagnementDetail }}
                </span>
              </span>
            </div>

            <div class="col-md-4 reponses"></div>
            <br>
            <div class="col-md-12 reponses">
              <span class="question">NOTES SUPPLÉMENTAIRES:</span>
              <span class="valeur">{{ usager.entretien.commentaires }}</span>
              <br>
            </div>
          </div>
        </ng-template>
      </ngb-panel>

      <ngb-panel id="panel-5">
        <ng-template
          ngbPanelHeader
          let-opened="opened">
          <div class="head-panel">
            <button
              ngbPanelToggle
              class="btn btn-link">
              <span>PIÈCES JOINTES</span>
              <span class="arrows">
                <fa-icon
                  *ngIf="opened"
                  icon="chevron-down"></fa-icon>
                <fa-icon
                  *ngIf="!opened"
                  icon="chevron-right"></fa-icon>
              </span>
            </button>
          </div>
        </ng-template>
        <ng-template ngbPanelContent>
          <app-upload
            *ngIf="usager.decision.statut === 'VALIDE'"
            [usager]="usager"></app-upload>
          <div *ngIf="usager.docs.length === 0">
            <ngb-alert [dismissible]="false">Aucune pièce-jointe enregistrée</ngb-alert>
          </div>
          <table
            class="table table-light"
            *ngIf="usager.docs.length > 0">
            <tbody>
              <tr>
                <th>#</th>
                <th>Nom de la pièce justificative</th>
                <th>Ajoutée le</th>
                <th>Ajoutée par</th>
                <th></th>
                <th></th>
              </tr>
              <tr *ngFor="let document of usager.docs; let indexDocs = index">
                <td>{{ indexDocs }}</td>
                <td>{{ document.label }}</td>
                <td>
                  {{ document.createdAt | date: 'dd/MM/yyyy' }}
                </td>
                <td>{{ document.createdBy }}</td>
                <td>
                  <button
                    (click)="getDocument(indexDocs)"
                    class="btn btn-primary"
                    aria-label="Voir la pièce jointe">
                    <fa-icon icon="download"></fa-icon>
                    Télécharger
                  </button>
                </td>
                <td>
                  <button
                    (click)="deleteDocument(indexDocs)"
                    class="btn btn-danger"
                    aria-label="Voir la pièce jointe">
                    <fa-icon icon="trash"></fa-icon>
                    Supprimer
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </ng-template>
      </ngb-panel>
    </ngb-accordion>
    <div
      class="text-center"
      *ngIf="usager.decision.statut === 'VALIDE'">
      <br>
      <div class="row">
        <div class="col-md-12">
          <button
            (click)="getAttestation()"
            class="btn btn-outline-primary">
            <fa-icon icon="file-pdf"></fa-icon>
            &nbsp; Télécharger l'attestation
          </button>
          &nbsp;
          <a
            [routerLink]="['/radiation/'+usager.id]"
            routerLinkActive="router-link-active"
            class="btn btn-outline-danger">
            <fa-icon icon="times"></fa-icon>
            Radier le domicilié
          </a>
          &nbsp;
          <button
            (click)="open(renewConfirmation)"
            class="btn btn-outline-secondary">
            <fa-icon icon="redo"></fa-icon>
            Demande de renouvellement
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template
  #renewConfirmation
  let-modal>
  <div class="modal-body text-center">
    <b>Attention</b>
    <br>
    <br>
    Si vous commencer un renouvellement,
    <br>
    <b>
      ce dossier ne sera plus compté comme "actif"
    </b>
    <br>
    <br>
    Afin de le retrouver dans la liste, vous devrez cliquer sur le filtre "A compléter
  </div>
  <div class="modal-footer">
    <button
      class="btn btn-outline-dark"
      (click)="modal.close('Save click')">
      Revenir au profil
    </button>
    <button
      class="btn btn-secondary"
      (click)="renouvellement();">
      Demander un renouvellement
    </button>
  </div>
</ng-template>
