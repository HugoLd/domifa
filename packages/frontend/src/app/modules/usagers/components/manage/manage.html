<div
  class="container"
  id="manage">
  <h4 class="text-center">
    <b>Bonjour {{ prenom }}</b>
  </h4>
  <div class="row">
    <div class="col-md-6 offset-md-3 ">
      <div class="form-group ">
        <div id="searchbar">
          <span id="search_icon">
            <fa-icon icon="search"></fa-icon>
          </span>
          <input
            type="text"
            [(ngModel)]="filters.name"
            #searchInput
            placeholder="Recherche par nom, prénom ou numéro de domicilié"
            class="form-control">
          <span
            *ngIf="searchInput.value !== ''"
            (click)="resetSearchBar()"
            id="times_icon">
            <fa-icon icon="times-circle"></fa-icon>
          </span>
        </div>
      </div>
    </div>
  </div>
  <div id="filters">
    <div class="row">
      <span>Statut :</span>
      <button
        class="btn"
        [ngClass]="
          filters.statut === 'VALIDE' ? 'btn-primary' : 'btn-outline-dark'
        "
        (click)="updateFilters('statut', 'VALIDE')">
        Actif
        <b *ngIf="filters.statut === 'VALIDE'">{{ usagers.length }}</b>
      </button>
      <button
        class="btn"
        [ngClass]="
          filters.statut === 'INSTRUCTION' ? 'btn-warning' : 'btn-outline-dark'
        "
        (click)="updateFilters('statut', 'INSTRUCTION')">
        À compléter
      </button>
      <button
        class="btn"
        [ngClass]="filters.statut === 'ATTENTE_DECISION' ? 'btn-warning' : 'btn-outline-dark' "
        (click)="updateFilters('statut', 'ATTENTE_DECISION')">
        En attente de décision
      </button>
      <button
        class="btn"
        [ngClass]="filters.statut === 'REFUS' ? 'btn-danger' : 'btn-outline-dark'  "
        (click)="updateFilters('statut', 'REFUS')">
        Refusé
      </button>
      <button
        class="btn"
        [ngClass]="filters.statut === 'RADIE' ? 'btn-danger' : 'btn-outline-dark'"
        (click)="updateFilters('statut', 'RADIE')">
        Radié
      </button>
    </div>
    <div class="row">
      <span>Courrier :</span>
      <button
        class="btn"
        [ngClass]="
          filters.interactionType === 'courrierIn'
            ? 'btn-dark'
            : 'btn-outline-dark'"
        (click)="updateFilters('interactionType', 'courrierIn')">
        Courrier à récupérer
      </button>
    </div>
  </div>

  <ngb-alert
    *ngIf="usagers.length === 0"
    [dismissible]="false"
    type="warning">
    <div class="text-center">
      <b>Aucun résultat :</b>
      aucun dossier ne correspond à votre recherche &nbsp;&nbsp;&nbsp;
      <button
        (click)="resetFilters()"
        class="btn btn-outline-white">
        Réinitialiser les filtres
      </button>
    </div>
  </ngb-alert>
  <div
    class="row"
    *ngIf="usagers.length !== 0">
    <table
      class="table"
      *ngIf="usagers.length !== 0">
      <thead>
        <th>Nom prénom</th>
        <th>{{ dateLabel }}</th>
        <td
          colspan="2"
          class="text-right">
          <div class="sort-structures form-group form-check-inline">
            <label for="sort">Trier par</label>
            <select
              class="form-control"
              id="sort"
              (change)="updateFilters('sort', $event.target.value)">
              <option value="az">Alphabétique : A -> Z</option>
              <option value="za">Alphabétique : Z -> A</option>
              <option value="radiation">Date de radiation à venir</option>
              <option value="domiciliation">Date de première domiciliation</option>
            </select>
          </div>
        </td>
      </thead>
      <tbody *ngFor="let usager of usagers; let i = index">
        <tr
          *ngIf="differentLetter(usager.nom, i)"
          class="letter">
          <td
            colspan="4"
            class=" text-center">
            {{ getLetter(usager.nom) }}
          </td>
        </tr>
        <tr>
          <td
            (click)="goToProfil(usager.id, usager.decision.statut)"
            scope="row"
            class="table_name">
            {{ usager.sexe === "homme" ? "M." : "Mme" }}
            <b>{{ usager.nom }}</b>
            {{ usager.prenom }}
            <span *ngIf="usager.surnom && usager.surnom !== null">({{ usager.surnom }})</span>
          </td>
          <td
            (click)="goToProfil(usager.id, usager.decision.statut)"
            class="font-weight-bold">
            <span
              *ngIf="usager.decision.statut === 'REFUS' ||
            usager.decision.statut === 'RADIE'"
              class="text-danger">
              {{ usager.decision.dateFin | date: "dd/MM/yyyy" }}
            </span>
            <span
              *ngIf="usager.decision.statut === 'VALIDE'"
              [ngClass]="{
              'text-danger': usager.dayBeforeEnd < 15,
              'text-warning': usager.dayBeforeEnd > 15 && usager.dayBeforeEnd < 60
            }">
              {{ usager.decision.dateFin | date: "dd/MM/yyyy" }}
            </span>
            <span *ngIf="usager.decision.statut === 'INSTRUCTION' || usager.decision.statut === 'ATTENTE_DECISION'">
              {{ usager.decision.dateDecision | date: "dd/MM/yyyy" }}
            </span>
          </td>
          <td
            class="text-right icones_liste"
            *ngIf="usager.decision.statut === 'VALIDE'">
            <div>
              <span ngbTooltip="Ajouter un nouveau courrier">
                <fa-icon
                  class="courrier"
                  icon="envelope"></fa-icon>
              </span>
              <span
                (click)="setPassage(usager, 'courrierOut')"
                *ngIf="usager.lastInteraction.nbCourrier > 0"
                ngbTooltip="Signaler un retrait de courrier">
                <fa-icon
                  class="courrier"
                  icon="envelope-open-text"></fa-icon>
                <b class="notification">{{ usager.lastInteraction.nbCourrier }}</b>
              </span>
              <span
                ngbTooltip="Signaler un passage"
                (click)="setPassage(usager, 'visite')">
                <fa-icon
                  class="visite"
                  icon="walking"></fa-icon>
              </span>
              <span
                ngbTooltip="Signaler un appel"
                (click)="setPassage(usager, 'appel')">
                <fa-icon
                  class="appel"
                  icon="phone"></fa-icon>
              </span>
            </div>
          </td>
          <td
            (click)="goToProfil(usager.id, usager.decision.statut)"
            class="text-right usager_informations"
            *ngIf="usager.decision.statut !== 'VALIDE'">
            <span
              *ngIf="usager.decision.statut === 'INSTRUCTION'"
              class="text-warning2">
              <fa-icon [icon]="['far', 'clock']"></fa-icon>
              Dossier à compléter
            </span>
            <span
              *ngIf="usager.decision.statut === 'ATTENTE_DECISION'"
              class="text-dark">
              Demande en cours
            </span>
            <span
              *ngIf="usager.decision.statut === 'REFUS'"
              class="font-weight-bold text-danger">
              Demande refusée
            </span>
            <span
              *ngIf="usager.decision.statut === 'RADIE'"
              class="font-weight-bold text-danger">
              Radié
            </span>

          </td>
          <td
            (click)="goToProfil(usager.id, usager.decision.statut)"
            class="text-right">
            <span
              class="active"
              *ngIf="
                usager.decision.statut !== 'ATTENTE_DECISION' &&
                usager.decision.statut !== 'INSTRUCTION'
              ">
              Accéder à sa fiche
            </span>
            <span
              class="active"
              *ngIf="usager.decision.statut === 'ATTENTE_DECISION'">
              <fa-icon [icon]="['fas', 'hourglass-half']"></fa-icon>
              &nbsp; Afficher la demande
            </span>
            <span
              class="active"
              *ngIf="usager.decision.statut === 'INSTRUCTION'">
              Reprendre la demande
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
